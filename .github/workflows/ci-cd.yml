name: Enhanced CI/CD Pipeline

on:
  push:
    branches: [develop, main]
  pull_request:
    branches: [main]
  release:
    types: [published]

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.9'

jobs:
  # Pre-flight validation
  validate-environment:
    name: Validate Environment Configuration
    runs-on: ubuntu-latest
    outputs:
      staging-ready: ${{ steps.check-staging.outputs.ready }}
      production-ready: ${{ steps.check-production.outputs.ready }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Staging Environment
        id: check-staging
        run: |
          echo "üîç Checking staging environment configuration..."
          
          # Check if staging environment exists (simulated check)
          STAGING_VARS=("GCP_PROJECT_ID" "GCP_REGION" "GCP_SA_KEY" "DB_HOST" "DB_PASSWORD" "JWT_SECRET")
          missing_vars=()
          
          for var in "${STAGING_VARS[@]}"; do
            if [ -z "${{ secrets[var] }}" ]; then
              missing_vars+=("$var")
            fi
          done
          
          if [ ${#missing_vars[@]} -eq 0 ]; then
            echo "‚úÖ All staging environment variables configured"
            echo "ready=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Missing staging variables: ${missing_vars[*]}"
            echo "ready=false" >> $GITHUB_OUTPUT
            echo "üìã To fix, add these secrets to staging environment:"
            for var in "${missing_vars[@]}"; do
              echo "  - $var"
            done
          fi

      - name: Check Production Environment
        id: check-production
        run: |
          echo "üîç Checking production environment configuration..."
          
          # Check if production environment exists (simulated check)
          PROD_VARS=("GCP_PROJECT_ID_PROD" "GCP_REGION_PROD" "GCP_SA_KEY_PROD" "DB_HOST_PROD" "DB_PASSWORD_PROD" "JWT_SECRET_PROD")
          missing_vars=()
          
          for var in "${PROD_VARS[@]}"; do
            if [ -z "${{ secrets[var] }}" ]; then
              missing_vars+=("$var")
            fi
          done
          
          if [ ${#missing_vars[@]} -eq 0 ]; then
            echo "‚úÖ All production environment variables configured"
            echo "ready=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Missing production variables: ${missing_vars[*]}"
            echo "ready=false" >> $GITHUB_OUTPUT
            echo "üìã To fix, add these secrets to production environment:"
            for var in "${missing_vars[@]}"; do
              echo "  - $var"
            done
          fi

  # Enhanced testing
  test-and-validate:
    name: Test and Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm run test

      - name: Validate configuration
        run: |
          echo "üîç Validating project configuration..."
          
          # Check package.json
          if [ -f "package.json" ]; then
            echo "‚úÖ package.json found"
          else
            echo "‚ùå package.json missing"
            exit 1
          fi
          
          # Check TypeScript configuration
          if [ -f "tsconfig.json" ] || find . -name "tsconfig.json" | grep -q .; then
            echo "‚úÖ TypeScript configuration found"
          else
            echo "‚ö†Ô∏è No TypeScript configuration found"
          fi
          
          # Check Docker configuration
          if [ -f "Dockerfile" ]; then
            echo "‚úÖ Dockerfile found"
          else
            echo "‚ö†Ô∏è No Dockerfile found"
          fi

      - name: Security audit
        run: |
          echo "üîí Running security audit..."
          npm audit --audit-level=high || echo "‚ö†Ô∏è Security vulnerabilities found"

  # Enhanced staging deployment
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [validate-environment, test-and-validate]
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push' && needs.validate-environment.outputs.staging-ready == 'true'
    environment: 
      name: staging
      url: https://staging.reengine.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Staging Environment
        run: |
          echo "üîç Validating staging environment..."
          required_vars=("GCP_PROJECT_ID" "GCP_REGION" "GCP_SA_KEY" "DB_HOST" "DB_PASSWORD" "JWT_SECRET")
          
          for var in "${required_vars[@]}"; do
            if [ -z "${{ secrets[var] }}" ]; then
              echo "‚ùå $var not configured"
              exit 1
            fi
          done
          
          echo "‚úÖ Staging environment validation passed"

      - name: Setup Google Cloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          version: '555.0.0'
          project_id: ${{ secrets.GCP_PROJECT_ID }}
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          create_credentials_file: false

      - name: Configure Docker
        run: gcloud auth configure-docker

      - name: Build and Deploy
        run: |
          echo "üèóÔ∏è Building and deploying to staging..."
          
          # Build images
          docker build -t gcr.io/${{ secrets.GCP_PROJECT_ID }}/reengine-engine:${{ github.sha }} ./engine || {
            echo "‚ùå Docker build failed"
            exit 1
          }
          
          docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/reengine-engine:${{ github.sha }} || {
            echo "‚ùå Docker push failed"
            exit 1
          }
          
          # Deploy with health checks
          gcloud run deploy reengine-engine \
            --image=gcr.io/${{ secrets.GCP_PROJECT_ID }}/reengine-engine:${{ github.sha }} \
            --region=${{ secrets.GCP_REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --memory=512Mi \
            --cpu=1 \
            --timeout=300 \
            --set-env-vars=DB_HOST=${{ secrets.DB_HOST }},DB_PASSWORD=${{ secrets.DB_PASSWORD }},JWT_SECRET=${{ secrets.JWT_SECRET }} \
            --quiet || {
            echo "‚ùå Deployment failed"
            exit 1
          }

      - name: Deployment Health Check
        run: |
          echo "üîç Performing deployment health check..."
          
          ENGINE_URL=$(gcloud run services describe reengine-engine \
            --region=${{ secrets.GCP_REGION }} \
            --format='value(status.url)')
          
          echo "üåê Service URL: $ENGINE_URL"
          
          # Health check with timeout and retry
          timeout 120s bash -c "
            for i in {1..12}; do
              echo \"Health check attempt \$i/12...\"
              if curl -f --max-time 10 '$ENGINE_URL/health' 2>/dev/null; then
                echo \"‚úÖ Service is healthy\"
                break
              elif [ \$i -eq 12 ]; then
                echo \"‚ùå Health check failed after 12 attempts\"
                exit 1
              else
                echo \"‚è≥ Retrying in 10 seconds...\"
                sleep 10
              fi
            done
          " || {
            echo "‚ùå Health check failed completely"
            exit 1
          }

      - name: Post-Deployment Tests
        run: |
          echo "üß™ Running post-deployment tests..."
          ENGINE_URL=$(gcloud run services describe reengine-engine \
            --region=${{ secrets.GCP_REGION }} \
            --format='value(status.url)')
          
          # Run smoke tests
          echo "Testing API endpoints..."
          
          # Test health endpoint
          if curl -f "$ENGINE_URL/health" 2>/dev/null; then
            echo "‚úÖ Health endpoint working"
          else
            echo "‚ùå Health endpoint failed"
            exit 1
          fi
          
          # Test version endpoint (if exists)
          if curl -f "$ENGINE_URL/api/version" 2>/dev/null; then
            echo "‚úÖ Version endpoint working"
          else
            echo "‚ö†Ô∏è Version endpoint not available (optional)"
          fi
          
          echo "‚úÖ Post-deployment tests passed"

      - name: Notify Success
        if: success()
        run: |
          echo "üéâ Staging deployment successful!"
          
          # Send Slack notification if webhook is configured
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data '{"text":"‚úÖ Staging deployment successful: '"${{ github.sha }}"' deployed to https://staging.reengine.com"}' \
              ${{ secrets.SLACK_WEBHOOK_URL }} || echo "‚ö†Ô∏è Slack notification failed"
          else
            echo "‚ö†Ô∏è No Slack webhook configured"
          fi

      - name: Rollback on Failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed, initiating rollback..."
          
          PREVIOUS_REVISION=$(gcloud run services describe reengine-engine \
            --region=${{ secrets.GCP_REGION }} \
            --format='value(status.latestReadyRevision.name)' | head -n 2 | tail -n 1)
          
          if [ -n "$PREVIOUS_REVISION" ] && [ "$PREVIOUS_REVISION" != "$(gcloud run services describe reengine-engine --region=${{ secrets.GCP_REGION }} --format='value(status.latestReadyRevision.name)')" ]; then
            echo "üîÑ Rolling back to $PREVIOUS_REVISION"
            gcloud run services update-traffic reengine-engine \
              --region=${{ secrets.GCP_REGION }} \
              --to-revisions=$PREVIOUS_REVISION=100
            echo "üîÑ Rollback completed"
            
            # Send Slack notification
            if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
              curl -X POST -H 'Content-type: application/json' \
                --data '{"text":"üö® Staging deployment failed, rolled back to '"$PREVIOUS_REVISION"'"}' \
                ${{ secrets.SLACK_WEBHOOK_URL }} || echo "‚ö†Ô∏è Slack notification failed"
            fi
          else
            echo "‚ö†Ô∏è No previous revision found for rollback"
          fi

  # Enhanced production deployment
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [validate-environment, test-and-validate]
    if: github.event_name == 'release' && needs.validate-environment.outputs.production-ready == 'true'
    environment: 
      name: production
      url: https://reengine.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Production Environment
        run: |
          echo "üîç Validating production environment..."
          required_vars=("GCP_PROJECT_ID_PROD" "GCP_REGION_PROD" "GCP_SA_KEY_PROD" "DB_HOST_PROD" "DB_PASSWORD_PROD" "JWT_SECRET_PROD")
          
          for var in "${required_vars[@]}"; do
            if [ -z "${{ secrets[var] }}" ]; then
              echo "‚ùå $var not configured"
              exit 1
            fi
          done
          
          echo "‚úÖ Production environment validation passed"

      - name: Setup Google Cloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          version: '555.0.0'
          project_id: ${{ secrets.GCP_PROJECT_ID_PROD }}
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}
          create_credentials_file: false

      - name: Configure Docker
        run: gcloud auth configure-docker

      - name: Build and Deploy Production
        run: |
          echo "üèóÔ∏è Building and deploying to production..."
          VERSION=${{ github.event.release.tag_name }}
          
          # Build images
          docker build -t gcr.io/${{ secrets.GCP_PROJECT_ID_PROD }}/reengine-engine:$VERSION ./engine || {
            echo "‚ùå Docker build failed"
            exit 1
          }
          
          docker push gcr.io/${{ secrets.GCP_PROJECT_ID_PROD }}/reengine-engine:$VERSION || {
            echo "‚ùå Docker push failed"
            exit 1
          }
          
          # Deploy with production settings
          gcloud run deploy reengine-engine \
            --image=gcr.io/${{ secrets.GCP_PROJECT_ID_PROD }}/reengine-engine:$VERSION \
            --region=${{ secrets.GCP_REGION_PROD }} \
            --platform=managed \
            --allow-unauthenticated \
            --memory=1Gi \
            --cpu=2 \
            --timeout=300 \
            --min-instances=1 \
            --max-instances=10 \
            --set-env-vars=DB_HOST=${{ secrets.DB_HOST_PROD }},DB_PASSWORD=${{ secrets.DB_PASSWORD_PROD }},JWT_SECRET=${{ secrets.JWT_SECRET_PROD }} \
            --quiet || {
            echo "‚ùå Production deployment failed"
            exit 1
          }

      - name: Production Health Check
        run: |
          echo "üîç Performing production health check..."
          
          ENGINE_URL=$(gcloud run services describe reengine-engine \
            --region=${{ secrets.GCP_REGION_PROD }} \
            --format='value(status.url)')
          
          echo "üåê Production URL: $ENGINE_URL"
          
          # Extended health check for production
          timeout 180s bash -c "
            for i in {1..18}; do
              echo \"Production health check attempt \$i/18...\"
              if curl -f --max-time 15 '$ENGINE_URL/health' 2>/dev/null; then
                echo \"‚úÖ Production service is healthy\"
                break
              elif [ \$i -eq 18 ]; then
                echo \"‚ùå Production health check failed after 18 attempts\"
                exit 1
              else
                echo \"‚è≥ Retrying in 15 seconds...\"
                sleep 15
              fi
            done
          " || {
            echo "‚ùå Production health check failed completely"
            exit 1
          }

      - name: Production Tests
        run: |
          echo "üß™ Running production tests..."
          ENGINE_URL=$(gcloud run services describe reengine-engine \
            --region=${{ secrets.GCP_REGION_PROD }} \
            --format='value(status.url)')
          
          # Comprehensive production tests
          echo "Testing production endpoints..."
          
          # Test health endpoint
          if curl -f "$ENGINE_URL/health" 2>/dev/null; then
            echo "‚úÖ Production health endpoint working"
          else
            echo "‚ùå Production health endpoint failed"
            exit 1
          fi
          
          # Test response time
          response_time=$(curl -o /dev/null -s -w '%{time_total}' "$ENGINE_URL/health")
          if (( $(echo "$response_time < 2.0" | bc -l) )); then
            echo "‚úÖ Response time acceptable: ${response_time}s"
          else
            echo "‚ö†Ô∏è Slow response time: ${response_time}s"
          fi
          
          echo "‚úÖ Production tests passed"

      - name: Notify Production Success
        if: success()
        run: |
          echo "üéâ Production deployment successful!"
          VERSION=${{ github.event.release.tag_name }}
          
          # Send Slack notification
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data '{"text":"üöÄ PRODUCTION DEPLOYMENT: Version '"$VERSION"' successfully deployed to https://reengine.com"}' \
              ${{ secrets.SLACK_WEBHOOK_URL }} || echo "‚ö†Ô∏è Slack notification failed"
          fi

      - name: Production Rollback on Failure
        if: failure()
        run: |
          echo "‚ùå Production deployment failed, initiating rollback..."
          VERSION=${{ github.event.release.tag_name }}
          
          PREVIOUS_REVISION=$(gcloud run services describe reengine-engine \
            --region=${{ secrets.GCP_REGION_PROD }} \
            --format='value(status.latestReadyRevision.name)' | head -n 2 | tail -n 1)
          
          if [ -n "$PREVIOUS_REVISION" ] && [ "$PREVIOUS_REVISION" != "$(gcloud run services describe reengine-engine --region=${{ secrets.GCP_REGION_PROD }} --format='value(status.latestReadyRevision.name)')" ]; then
            echo "üîÑ Rolling back production to $PREVIOUS_REVISION"
            gcloud run services update-traffic reengine-engine \
              --region=${{ secrets.GCP_REGION_PROD }} \
              --to-revisions=$PREVIOUS_REVISION=100
            echo "üîÑ Production rollback completed"
            
            # Send critical Slack notification
            if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
              curl -X POST -H 'Content-type: application/json' \
                --data '{"text":"üö® CRITICAL: Production deployment of version '"$VERSION"' failed, rolled back to '"$PREVIOUS_REVISION"'"}' \
                ${{ secrets.SLACK_WEBHOOK_URL }} || echo "‚ö†Ô∏è Slack notification failed"
            fi
          else
            echo "‚ö†Ô∏è No previous revision found for production rollback"
          fi

  # Performance tests (only if staging deployment succeeded)
  performance-test:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: [deploy-staging]
    if: github.ref == 'refs/heads/develop' && needs.deploy-staging.result == 'success'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Run Performance Tests
        run: |
          echo "üß™ Running performance tests..."
          
          # Get staging URL
          ENGINE_URL=$(gcloud run services describe reengine-engine \
            --region=${{ secrets.GCP_REGION }} \
            --format='value(status.url)')
          
          echo "üåê Testing against: $ENGINE_URL"
          
          # Load test
          echo "Running load test..."
          for i in {1..10}; do
            response_time=$(curl -o /dev/null -s -w '%{time_total}' "$ENGINE_URL/health")
            echo "Request $i: ${response_time}s"
            
            if (( $(echo "$response_time > 1.0" | bc -l) )); then
              echo "‚ö†Ô∏è Slow response detected: ${response_time}s"
            fi
          done
          
          echo "‚úÖ Performance tests completed"

      - name: Upload Performance Results
        uses: actions/upload-artifact@v3
        with:
          name: performance-results
          path: performance-results/

  # Environment setup helper
  setup-environments:
    name: Environment Setup Helper
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Generate Environment Setup Guide
        run: |
          echo "üìã Environment Setup Guide"
          echo "========================"
          echo ""
          echo "To fix the CI/CD issues, follow these steps:"
          echo ""
          echo "1. Create GitHub Environments:"
          echo "   - Go to Repository Settings ‚Üí Environments"
          echo "   - Create 'staging' environment"
          echo "   - Create 'production' environment with protection rules"
          echo ""
          echo "2. Add Staging Environment Secrets:"
          echo "   - GCP_PROJECT_ID: Your GCP project ID"
          echo "   - GCP_REGION: Deployment region (e.g., us-central1)"
          echo "   - GCP_SA_KEY: Service account key JSON"
          echo "   - DB_HOST: Database host URL"
          echo "   - DB_PASSWORD: Database password"
          echo "   - JWT_SECRET: JWT signing secret"
          echo ""
          echo "3. Add Production Environment Secrets:"
          echo "   - GCP_PROJECT_ID_PROD: Production GCP project ID"
          echo "   - GCP_REGION_PROD: Production deployment region"
          echo "   - GCP_SA_KEY_PROD: Production service account key"
          echo "   - DB_HOST_PROD: Production database host"
          echo "   - DB_PASSWORD_PROD: Production database password"
          echo "   - JWT_SECRET_PROD: Production JWT secret"
          echo ""
          echo "4. Add Repository Secrets:"
          echo "   - SLACK_WEBHOOK_URL: Slack webhook for notifications"
          echo ""
          echo "5. Create GCP Service Accounts:"
          echo "   - Create service accounts with Cloud Run and Build permissions"
          echo "   - Download service account keys"
          echo "   - Add keys to GitHub secrets"
          echo ""
          echo "After setup, the CI/CD pipeline will work automatically!"
